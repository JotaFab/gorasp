<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Serial Chat</title>
    <style>
        body {
            font-family: monospace;
            background-color: #222;
            color: #eee;
        }
        #messages {
            width: 80%;
            height: 500px;
            overflow-y: auto;
            border: 1px solid #555;
            padding: 10px;
            margin: 20px auto;
            background-color: #111;
            white-space: pre-wrap;
        }
        input, button {
            padding: 10px;
            font-size: 16px;
            margin: 5px;
            background-color: #333;
            color: #eee;
            border: 1px solid #555;
        }
        .esp32-message {
            color: #4CAF50; /* Green */
            text-align: left;
        }
        .user-message {
            color: #2196F3; /* Blue */
            text-align: right;
        }
        #connectButton {
            background-color: red; /* Initial color */
        }
    </style>
</head>
<body>
    <h1>ESP32 Serial Chat</h1>
    <button id="connectButton" onclick="connect()" style="background-color: red;">Connect</button>
    <button id="scanAPsButton" onclick="scanAPs()">Scan APs</button>
    <div id="messages"></div>
    <h2>Available Networks:</h2>
    <ul id="apList"></ul>
    <input type="text" id="commandInput" placeholder="Type a command...">
    <button onclick="sendCommand()">Send</button>

    <script>
        const messagesDiv = document.getElementById("messages");
        let websocket;
        let serialConnected = false;
        let commandHistory = [];
        let commandIndex = -1;

        function connectWebSocket() {
            if (!serialConnected) {
                console.log("Serial not connected, delaying WebSocket connection.");
                return;
            }
            websocket = new WebSocket("/ws");

            websocket.onmessage = function(event) {
                const msg = event.data;
                const p = document.createElement("p");
                p.classList.add("esp32-message");
                p.textContent = "ESP32: " + msg;
                messagesDiv.appendChild(p);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            websocket.onclose = function(event) {
                console.log("WebSocket connection closed.");
                console.log("Close event details:", event);
                // Attempt to reconnect after a delay
                setTimeout(connectWebSocket, 3000);
            };

            websocket.onerror = function(error) {
                console.error("WebSocket error:", error);
                console.error("Error details:", error.message || error);
            };
        }

        async function connect() {
            const connectButton = document.getElementById("connectButton");
            try {
                const response = await fetch("/connect", { method: "POST" });
                const data = await response.json();
                if (data.status === "success") {
                    console.log("Serial connected successfully.");
                    serialConnected = true;
                    connectButton.style.backgroundColor = "green"; // Change button color
                    connectWebSocket(); // Now connect WebSocket
                } else {
                    console.error("Failed to connect to serial:", data.error);
                    alert("Failed to connect to serial: " + data.error);
                    connectButton.style.backgroundColor = "red"; // Ensure button is red on failure
                }
            } catch (error) {
                console.error("Error connecting to serial:", error);
                alert("Error connecting to serial: " + error);
                connectButton.style.backgroundColor = "red"; // Ensure button is red on error
            }
        }

        async function scanAPs() {
            const commandInput = document.getElementById("commandInput");
            const scanAPsButton = document.getElementById("scanAPsButton");

            try {
                // Disable the input field and the scan button
                commandInput.disabled = true;
                scanAPsButton.disabled = true;

                const response = await fetch("/scan_aps", { method: "POST" });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                }
                const data = await response.json();
                if (data.status === "success") {
                    console.log("AP scan completed successfully.");

                    // Clear the existing list
                    const apList = document.getElementById("apList");
                    apList.innerHTML = "";

                    // Populate the list with the scanned APs
                    data.aps.forEach(ssid => {
                        const li = document.createElement("li");
                        li.textContent = `SSID: ${ssid}`;
                        apList.appendChild(li);
                    });

                } else {
                    console.error("Failed to scan APs:", data.error);
                    alert("Failed to scan APs: " + data.error);
                }
            } catch (error) {
                console.error("Error scanning APs:", error);
                alert("Error scanning APs: " + error);
            } finally {
                // Re-enable the input field and the scan button after 10 seconds
                setTimeout(() => {
                    commandInput.disabled = false;
                    scanAPsButton.disabled = false;
                }, 12000); // 10 seconds
            }
        }

        // Add event listener for Enter key and arrow keys
        document.getElementById("commandInput").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // Prevent form submission
                sendCommand();
            } else if (event.key === "ArrowUp") {
                event.preventDefault(); // Prevent cursor movement
                if (commandHistory.length > 0) {
                    if (commandIndex === -1) {
                        commandIndex = commandHistory.length - 1;
                    } else if (commandIndex > 0) {
                        commandIndex--;
                    }
                    document.getElementById("commandInput").value = commandHistory[commandIndex];
                }
            } else if (event.key === "ArrowDown") {
                event.preventDefault(); // Prevent cursor movement
                if (commandHistory.length > 0) {
                    if (commandIndex < commandHistory.length - 1) {
                        commandIndex++;
                        document.getElementById("commandInput").value = commandHistory[commandIndex];
                    } else {
                        commandIndex = commandHistory.length;
                        document.getElementById("commandInput").value = "";
                    }
                }
                if (commandIndex >= commandHistory.length) {
                    document.getElementById("commandInput").value = "";
                    commandIndex = commandHistory.length;
                }
            }
        });

        async function sendCommand() {
            const command = document.getElementById("commandInput").value;
            if (!command.trim()) return;
            
            // Display user message immediately
            const p = document.createElement("p");
            p.classList.add("user-message");
            p.textContent = "You: " + command;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            fetch("/send", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command })
            });

            document.getElementById("commandInput").value = "";
            commandHistory.push(command); // Add command to history
            commandIndex = commandHistory.length; // Reset command index
        }

        // Remove the fetchMessages function and the setInterval call
    </script>
</body>
</html>

